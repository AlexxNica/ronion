/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(u){if("object"===typeof exports&&"undefined"!==typeof module)module.exports=u();else if("function"===typeof define&&define.b)define([],u);else{var e;"undefined"!==typeof window?e=window:"undefined"!==typeof global?e=global:"undefined"!==typeof self?e=self:e=this;e.ea=u()}})(function(){return function r(e,m,n){function h(f,k){if(!m[f]){if(!e[f]){var a="function"==typeof require&&require;if(!k&&a)return a(f,!0);if(l)return l(f,!0);k=Error("Cannot find module '"+f+"'");throw k.code="MODULE_NOT_FOUND",
k;}k=m[f]={exports:{}};e[f][0].call(k.exports,function(a){var b=e[f][1][a];return h(b?b:a)},k,k.exports,r,e,m,n)}return m[f].exports}for(var l="function"==typeof require&&require,f=0;f<n.length;f++)h(n[f]);return h}({1:[function(e,m,n){(function(){function e(){if(!(this instanceof e))return new e;this.H={}}e.prototype={on:function(h,e){var f;h&&e&&((f=this.H)[h]||(f[h]=[])).push(e);return this},off:function(h,e){(h=this.H[h])&&h.splice(h.indexOf(e),e?1:h.length);return this},once:function(e,l){var f=
this;if(e&&l){var h=function(){f.off(e,h);return l.apply(null,arguments)};this.on(e,h)}return this},fire:function(e,l){var f=Promise.resolve();var h=arguments;(this.H[e]||[]).forEach(function(e){f=f.then(function(){var a=e.call.apply(e,h);return!1===a?Promise.reject():a})});f["catch"](function(f){f instanceof Error&&console.error(f)});return f}};"object"===typeof n?m.exports=e:this.async_eventer=e}).call(this)},{}],2:[function(e,m){(function(){function n(a){return 256*a[0]+a[1]}function r(a){var b=
a%256;return Uint8Array.of((a-b)/256,b)}function h(a,b,c,d){a=new Uint8Array(a);a.set([b]);a.set(c,1);a.set(d,3);return a}function l(a,b,c){c=new Uint8Array(3+c);c.set([a]);c.set(r(b.length),1);c.set(b,3);return c}function f(a,b){return a.join(",")+b.join(",")}function p(a,b,c,d,g){null==g&&(g=10);if(!(this instanceof p))return new p(a,b,c,d,g);k.call(this);this.A=a;this.l=b;this.G=c;this.C=d;this.X=g;this.b=new Map;this.g=new Set;this.h=new Map;this.v=new Map;this.w=new Map;this.c=new Map}var k=
e("async-eventer");m.exports=p;p.prototype={process_packet:function(a,b){if(b.length===this.l){var c=[b[0],b.subarray(1,3),b.subarray(3)];var d=c[0];b=c[1];c=c[2];d===this.A&&(d=f(a,b),this.b.has(d)||this.g.has(d)||this.c.has(d)?this.Y(a,b,c):this.Z(a,b,c))}},confirm_outgoing_segment_established:function(a,b){this.b.set(f(a,b),[a]);this.i(a,b)},confirm_incoming_segment_established:function(a,b){this.g.add(f(a,b));this.i(a,b)},confirm_extended_path:function(a,b){a=f(a,b);b=this.w.get(a);this.b.get(a).push(b);
this.w["delete"](a)},create_request:function(a,b){if(b.length>this.m())throw new RangeError("Too much command data");var c=this.W(a);b=this.J(c,1,b);this.fire("send",{a:a,j:b});this.u(a,c);return c},create_response:function(a,b,c){if(c.length>this.m())throw new RangeError("Too much command data");b=this.J(b,2,c);this.fire("send",{a:a,j:b})},extend_request:function(a,b,c,d){var g,q=this;var e=f(a,b);if(!this.b.has(e))throw new ReferenceError("There is no such segment established");if(d.length>this.m()-
this.G)throw new RangeError("Too much command data");var t=this.b.get(e).slice(-1)[0];var h=g=new Uint8Array(c.length+d.length);h.set(c);h.set(d,c.length);this.s(a,b,t,3,g).then(function(b){q.fire("send",{a:a,j:b});q.w.set(e,c)})},V:function(a,b,c){var d=this;this.s(a,b,a,4,c).then(function(b){d.fire("send",{a:a,j:b})})},destroy:function(a,b){var c=this;var d=f(a,b);if(!this.b.has(d))throw new ReferenceError("There is no such segment established");var g=this.b.get(d);this.s(a,b,g[g.length-1],5,new Uint8Array(0)).then(function(b){g.pop();
if(!g.length)c.b["delete"](d);c.fire("send",{a:a,j:b})})},data:function(a,b,c,d){var g=this;var e=f(a,b);if(!this.b.has(e)&&!this.g.has(e))throw new ReferenceError("There is no such segment established");if(d.length>this.m())throw new RangeError("Too much command data");this.s(a,b,c,6,d).then(function(b){g.fire("send",{a:a,j:b})})},get_max_command_data_length:function(){return this.l-1-2-1-2-this.C},Z:function(a,b,c){var d=f(a,b);c=[c[0],c.slice(3,3+n(c.subarray(1,3)))];var g=c[0];c=c[1];switch(g){case 1:this.u(a,
b);this.fire("create_request",{a:a,f:b,D:c});break;case 2:this.h.has(d)&&(d=this.h.get(d),d.N?(a=d.N,this.V(a.a,a.f,c)):this.fire("create_response",{a:a,f:b,D:c}))}},Y:function(a,b,c){var d=this;this.$(a,b,c).then(function(c){var g=f(a,b);!d.g.has(g)&&d.c.has(g)?d.B(g,c):d.T(a,b,c).then(function(c){var f=[c[0],c.slice(3,3+n(c.subarray(1,3)))];c=f[0];f=f[1];switch(c){case 3:try{var e=f.subarray(0,d.G);var h=f.subarray(d.G);var q=d.ca(e,h);var v={a:a,f:b};var k={aa:e,ba:q};d.u(a,b,{M:k});d.u(e,q,{N:v})}catch(w){e=
w;if(!(e instanceof RangeError))throw e;d.da(a,b,new Uint8Array(0))}break;case 4:d.w.has(g)&&d.fire("extend_response",{a:a,f:b,D:f});break;case 5:d.g.has(g)&&(d.g["delete"](g),d.I(a,b),d.fire("destroy",{a:a,f:b}));break;case 6:d.fire("data",{a:a,f:b,D:f})}},function(){if(d.c.has(g))d.B(g,c);else if(d.h.has(g)){var f=d.h.get(g);if(f.M){var e=f.M;f=e.aa;e=e.ba;d.i(a,b);d.i(f,e);d.S(a,b,f,e);d.B(g,c)}}})})},B:function(a,b){var c=this.c.get(a);a=c[0];b=h(this.l,this.A,c[1],b);this.fire("send",{a:a,j:b})},
W:function(a){var b;var c=0;for(b=Math.pow(2,16);c<b;++c){var d=c;d=r(d);var g=f(a,d);if(!this.b.has(g)&&!this.h.has(g)&&!this.g.has(g))return d}throw new RangeError("Out of possible segment IDs");},J:function(a,b,c){b=l(b,c,this.m());return h(this.l,this.A,a,b)},s:function(a,b,c,d,f){var g=this;d=l(d,f,this.m());return this.U(a,b,c,d).then(function(a){return h(g.l,g.A,b,a)})},S:function(a,b,c,d){this.I(a,b);this.I(c,d);var g=f(a,b);var e=f(c,d);this.c.set(g,[c,d]);this.c.set(e,[a,b])},I:function(a,
b){a=f(a,b);if(this.c.has(a)){var c=this.c.get(a);b=c[0];c=c[1];b=f(b,c);this.c["delete"](a);this.c["delete"](b)}},u:function(a,b,c){!c&&(c={});this.i(a,b);var d=f(a,b);var g=a.join("");this.h.set(d,c);this.v.has(g)||this.v.set(g,[]);c=this.v.get(g);c.push(b);c.length>this.X&&(b=c.shift(),this.i(a,b))},i:function(a,b){var c;var d=f(a,b);if(this.h.has(d))for(this.h["delete"](d),a=a.join(""),b=b.join(""),a=this.v.get(a),d=0,c=a.length;d<c;++d){var g=d;var e=a[d];if(e.join("")===b){a.splice(g,1);break}}},
U:function(a,b,c,d){var e,h=this;var k=f(a,b);var t={a:a,f:b,F:c,O:d,o:null};var l=this.fire("encrypt",t).then(function(){var a=t.o;if(!(a instanceof Uint8Array)||a.length!==d.length+h.C)throw Error("Encryption failed");return a});this.b.has(k)?e=this.b.get(k):e=[c];var m=c.join("");e.every(function(c){l=l.then(function(d){return h.L(a,b,c,d)});return m!==c.join("")});l["catch"](function(){});return l},T:function(a,b,c){var d,e=this;var h=f(a,b);this.b.has(h)?d=this.b.get(h):d=[a];var k=Promise.reject();
var l={a:a,f:b,fa:null,o:c,O:null};d.forEach(function(d,f){k=k["catch"](function(){l.F=d;return 0<f?e.K(a,b,d,l.o).then(function(a){l.o=a;return e.fire("decrypt",l)}):e.fire("decrypt",l)}).then(function(){var a=l.O;if(!(a instanceof Uint8Array)||a.length!==c.length-e.C)throw Error("Decryption failed");return a})});k["catch"](function(){});return k},$:function(a,b,c){var d=f(a,b);if(this.b.has(d)||this.g.has(d))return this.K(a,b,a,c);a=this.c.get(d);b=a[0];return this.L(b,a[1],b,c)},L:function(a,b,
c,d){var e={a:a,f:b,F:c,P:d,R:null};a=this.fire("wrap",e).then(function(){var a=e.R;if(!(a instanceof Uint8Array)||a.length!==d.length)throw Error("Re-wrapping failed");return a});a["catch"](function(){});return a},K:function(a,b,c,d){var e={a:a,f:b,F:c,R:d,P:null};a=this.fire("unwrap",e).then(function(){var a=e.P;if(!(a instanceof Uint8Array)||a.length!==d.length)throw Error("Re-wrapping failed");return a});a["catch"](function(){});return a}};p.prototype=Object.assign(Object.create(k.prototype),
p.prototype);Object.defineProperty(p.prototype,"constructor",{enumerable:!1,value:p})}).call(this)},{"async-eventer":1}]},{},[2])(2)});